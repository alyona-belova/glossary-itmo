<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>Глоссарий — Семантический Граф</title>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script src="./data.js"></script>
    <style>
      body {
        margin: 0;
        font-family: system-ui, sans-serif;
        background: #f7f7fb;
        color: #333;
        display: flex;
        height: 100vh;
        overflow: hidden;
      }

      #sidebar {
        width: 320px;
        background: white;
        border-right: 1px solid #ddd;
        padding: 20px;
        overflow-y: auto;
        box-shadow: 2px 0 8px rgba(0, 0, 0, 0.05);
      }

      #sidebar h2 {
        margin-top: 0;
        font-size: 22px;
        font-weight: 600;
      }

      .term-item {
        padding: 8px 10px;
        cursor: pointer;
        border-radius: 8px;
        transition: 0.2s;
      }

      .term-item:hover {
        background: #eef1ff;
      }

      #mynetwork {
        flex: 1;
        background: #ffffff;
      }

      .header {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 10px;
      }

      div.vis-tooltip {
        position: absolute;
        visibility: hidden;
        padding: 10px;
        white-space: nowrap;
        color: #000000;
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 5px;
        border: none;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        pointer-events: none;
        z-index: 1000;
      }
    </style>
    <!-- Yandex.Metrika counter -->
    <script type="text/javascript">
      (function (m, e, t, r, i, k, a) {
        m[i] =
          m[i] ||
          function () {
            (m[i].a = m[i].a || []).push(arguments);
          };
        m[i].l = 1 * new Date();
        for (var j = 0; j < document.scripts.length; j++) {
          if (document.scripts[j].src === r) {
            return;
          }
        }
        (k = e.createElement(t)),
          (a = e.getElementsByTagName(t)[0]),
          (k.async = 1),
          (k.src = r),
          a.parentNode.insertBefore(k, a);
      })(
        window,
        document,
        "script",
        "https://mc.yandex.ru/metrika/tag.js?id=105738532",
        "ym"
      );

      ym(105738532, "init", {
        ssr: true,
        webvisor: true,
        clickmap: true,
        ecommerce: "dataLayer",
        accurateTrackBounce: true,
        trackLinks: true,
      });
    </script>
    <noscript
      ><div>
        <img
          src="https://mc.yandex.ru/watch/105738532"
          style="position: absolute; left: -9999px"
          alt=""
        /></div
    ></noscript>
  </head>
  <body>
    <div id="sidebar">
      <h2>Глоссарий</h2>
      <div id="term-list">Загрузка...</div>
    </div>

    <div id="mynetwork"></div>

    <script>
      const terms = window.GLOSSARY_TERMS;
      const list = document.getElementById("term-list");

      list.innerHTML = "";
      terms.forEach((t) => {
        const div = document.createElement("div");
        div.className = "term-item";
        div.textContent = t.term;
        div.onclick = () => (window.location.href = `./term-${t.id}.html`);
        list.appendChild(div);
      });

      let variant = localStorage.getItem("graph_variant");
      if (!variant) {
        variant = Math.random() < 0.5 ? "A" : "B";
        localStorage.setItem("graph_variant", variant);
      }
      ym(105738532, "reachGoal", "some_goal", { ab_test: variant });

      function loadD3(callback) {
        if (window.d3) {
          callback();
          return;
        }

        const script = document.createElement("script");
        script.src = "https://d3js.org/d3.v7.min.js";
        script.async = true;
        script.onload = () => {
          callback();
        };
        document.body.appendChild(script);
      }

      if (variant === "A") {
        renderStaticGraph();
      } else {
        loadD3(renderInteractiveGraph);
      }

      function renderStaticGraph() {
        const nodes = new vis.DataSet(
          window.GLOSSARY_TERMS.map((t) => ({
            id: t.id,
            label: t.term,
          }))
        );

        const edges = new vis.DataSet(window.GLOSSARY_GRAPH.edges);

        const options = {
          physics: false,
          interaction: {
            hover: false,
          },
          nodes: {
            shape: "dot",
            size: 25,
            font: { color: "#000" },
            color: {
              background: "#5C7FFF",
            },
          },
          edges: {
            color: "#ccc",
          },
        };

        const network = new vis.Network(
          document.getElementById("mynetwork"),
          { nodes, edges },
          options
        );

        network.on("click", (params) => {
          if (params.nodes.length) {
            window.location.href = `./term-${params.nodes[0]}.html`;
          }
        });
      }

      function renderInteractiveGraph() {
        const width = document.getElementById("mynetwork").clientWidth;
        const height = document.getElementById("mynetwork").clientHeight;

        const svg = d3
          .select("#mynetwork")
          .append("svg")
          .attr("width", width)
          .attr("height", height);

        const nodes = window.GLOSSARY_TERMS.map((t) => ({ ...t }));
        const links = window.GLOSSARY_GRAPH.edges.map((e) => ({
          source: e.from,
          target: e.to,
        }));

        const simulation = d3
          .forceSimulation(nodes)
          .force(
            "link",
            d3
              .forceLink(links)
              .id((d) => d.id)
              .distance(120)
          )
          .force("charge", d3.forceManyBody().strength(-430))
          .force("collision", d3.forceCollide(55))
          .force("center", d3.forceCenter(width / 2, height / 2))
          .alphaDecay(0.06);

        setTimeout(() => simulation.stop(), 2000);

        const link = svg
          .append("g")
          .selectAll("line")
          .data(links)
          .enter()
          .append("line")
          .attr("stroke", "#aaa");

        const node = svg
          .append("g")
          .selectAll("circle")
          .data(nodes)
          .enter()
          .append("circle")
          .attr("r", 20)
          .attr("fill", "#5b7fff")
          .call(
            d3
              .drag()
              .on("start", dragstarted)
              .on("drag", dragged)
              .on("end", dragended)
          )
          .on("click", (event, d) => {
            window.location.href = `./term-${d.id}.html`;
          });

        const label = svg
          .append("g")
          .selectAll("text")
          .data(nodes)
          .enter()
          .append("text")
          .text((d) => d.term)
          .attr("text-anchor", "middle")
          .attr("dy", "-1.9em")
          .attr("font-size", "12px")
          .style("font-weight", "500")
          .attr("fill", "#333")
          .style("pointer-events", "none")
          .style("user-select", "none");

        const tooltip = d3
          .select("body")
          .append("div")
          .style("position", "absolute")
          .style("padding", "8px")
          .style("background", "rgba(255,255,255,0.9)")
          .style("border-radius", "6px")
          .style("box-shadow", "0 4px 12px rgba(0,0,0,0.15)")
          .style("visibility", "hidden");

        node
          .on("mouseover", (event, d) => {
            tooltip.text(d.tooltip).style("visibility", "visible");
          })
          .on("mousemove", (event) => {
            tooltip
              .style("top", event.pageY + 10 + "px")
              .style("left", event.pageX + 10 + "px");
          })
          .on("mouseout", () => {
            tooltip.style("visibility", "hidden");
          });

        const radius = 10;
        const padding = 20;

        simulation.on("tick", () => {
          nodes.forEach((d) => {
            d.x = Math.max(
              radius + padding,
              Math.min(width - radius - padding, d.x)
            );
            d.y = Math.max(
              radius + padding,
              Math.min(height - radius - padding, d.y)
            );
          });
          link
            .attr("x1", (d) => d.source.x)
            .attr("y1", (d) => d.source.y)
            .attr("x2", (d) => d.target.x)
            .attr("y2", (d) => d.target.y);
          node.attr("cx", (d) => d.x).attr("cy", (d) => d.y);
          label.attr("x", (d) => d.x).attr("y", (d) => d.y);
        });

        function dragstarted(event) {
          if (!event.active) simulation.alphaTarget(0.3).restart();
          event.subject.fx = event.subject.x;
          event.subject.fy = event.subject.y;
        }

        function dragged(event) {
          event.subject.fx = event.x;
          event.subject.fy = event.y;
        }

        function dragended(event) {
          if (!event.active) simulation.alphaTarget(0);
          event.subject.fx = null;
          event.subject.fy = null;
        }
      }
    </script>
  </body>
</html>
